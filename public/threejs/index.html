<!doctype html>
<html>
<head>
</head>

<body>

    <script src="../Scripts/jquery-2.1.1.min.js"></script>
    <!--Load three.js-->
    <script src="three.min.js"></script>
    <script src="OrbitControls.js"></script>

    <script>
        var width = 800;
        var heigth = 600;
        var scene = new THREE.Scene();
        var camera = new THREE.PerspectiveCamera(45, width / heigth, 0.1, 1000);
        //		camera.position.z = 10;
        var renderer = new THREE.WebGLRenderer();

        renderer.setSize(width, heigth);
        renderer.setClearColor(0x555555);
        document.body.appendChild(renderer.domElement);

        var monkeyMaterial;
        var monkeyGeometry;
        var bombMaterial;
        var bombGeometry;
        var blenderScale = 0.4;
        var modelsNum = 4;
        var loadedModels = 0;

        var player = {
     
        };

        var grid;
		var powerUp1Material;
		var powerUp2Material;			
		
        function init() {

            if (loadedModels < modelsNum)
                return;

            var boxSize = .8;
            var boxSizeBorder = 1;
            var xScale = 11;
            var yScale = 9;
            var borderHeight = boxSizeBorder / 2;
            var gridObjects = {};
            grid = [
						['%', '%', '%', '%', '%', '%', '%', '%', '%', '%', '%'],
                        ['%', 'A', '@', '$', '$', '$', '$', '$', ' ', '2', '%'],
                        ['%', ' ', '#', '$', '#', '$', '#', '$', '#', '2', '%'],
                        ['%', '$', '$', '$', '$', '$', '$', '$', '$', '$', '%'],
                        ['%', '$', '#', '$', '#', '2', '#', '$', '#', '$', '%'],
                        ['%', '$', '$', '$', '$', '$', '$', '$', '$', '$', '%'],
                        ['%', '1', '#', '$', '#', '$', '#', '$', '#', '1', '%'],
                        ['%', 'C', ' ', '$', '$', '$', '$', '$', '1', '1', '%'],
						['%', '%', '%', '%', '%', '%', '%', '%', '%', '%', '%']
            ];

            var boxGeom = new THREE.BoxGeometry(boxSize, boxSize, boxSize);
            var boxGeomBorder = new THREE.BoxGeometry(boxSizeBorder, borderHeight, boxSizeBorder);
            var boxMaterial1 = new THREE.MeshLambertMaterial({ color: "#6f5ca8" });
            var boxMaterialFixed = new THREE.MeshLambertMaterial({ color: "#ffff00" });
            var borderMaterial = new THREE.MeshLambertMaterial({ color: "#ffff00", side: THREE.DoubleSide });
		
            var floorGeom = new THREE.PlaneGeometry(xScale, yScale);
            var floor = new THREE.Mesh(floorGeom, borderMaterial);
            floor.rotation.x = Math.PI / 2;
            floor.position.x = xScale / 2 - 0.5;
            floor.position.z = yScale / 2 - 0.5;

            floor.position.y = -boxSize/2;

            scene.add(floor);

            for (var y = 0; y < grid.length; y++) {
                var row = grid[y];
                for (var x = 0; x < row.length; x++) {
                    var col = row[x];
                 //   console.log(col);

                    var obj;
                    switch (col) {
                        case '$':
                            obj = new THREE.Mesh(boxGeom, boxMaterial1);
                            break;
                        case '#':
                            obj = new THREE.Mesh(boxGeom, boxMaterialFixed);
                            break;
                        case '@':
                            obj = new THREE.Mesh(bombGeometry, bombMaterial);
                            obj.scale.set(blenderScale, blenderScale, blenderScale);
                            break;
                        case '%':
                            obj = new THREE.Mesh(boxGeomBorder, boxMaterialFixed);
                            var yTrans = (boxSize - borderHeight) / 2;
                            obj.position.y -= yTrans;
                            break;
						  case '1':
                            obj =  new THREE.Sprite( powerUp1Material );
                           // var yTrans = (boxSize - borderHeight) / 2;
                         //   obj.position.y -= yTrans;
                            break;	
						case '2':
                            obj =  new THREE.Sprite( powerUp2Material );
                           // var yTrans = (boxSize - borderHeight) / 2;
                         //   obj.position.y -= yTrans;
                            break;
								//	var sprite = new THREE.Sprite( spriteMaterial );
		//	scene.add( sprite ); 
							
                        case 'A':
                            player.y = y;
                            player.x = x;
                            obj = new THREE.Mesh(monkeyGeometry, monkeyMaterial);
                            player.obj = obj;
                            obj.scale.set(blenderScale, blenderScale, blenderScale);
                            row[x] = ' ';
                            
                            break;
                    }
                    
                    if (obj) {
                        gridObjects[y + "_" + x] = obj;
                        obj.position.x = x;
                        obj.position.z = y;
                        scene.add(obj);
                    }
                    obj = null;
                }
            }

            // (color, intensity)
            var light = new THREE.PointLight(0xffffff, 0.9);
            // (x, y, z)
            light.position.set(xScale / 2, 10, yScale / 2);

            scene.add(light);
            render();

            camera.position.set(5.026834384743997, 11.565823248616343, 8.10856187385891);
            controls.target.set(5.026834384743997, -1.8699039169448395, 3.8555165223830943);

            $("body").keypress(function (event) {
                console.log(event.which);


                var tempY = player.y;
                var tempX = player.x;

                switch (event.which) {
                    case 119:
                        console.log("upp");
                        tempY--;
                        player.obj.rotation.y = Math.PI ;
                        break;
                    case 115:
                        console.log("ned");
                        player.obj.rotation.y = 0;
                        tempY++;
                        break;
                    case 97:
                        console.log("vänster");

                        player.obj.rotation.y =- Math.PI / 2;
                        tempX--;
                        break;
                    case 100:
                        console.log("höger");
                        player.obj.rotation.y = Math.PI / 2;
                        tempX++;
                        break;
                }

           
                var objOnPos = gridObjects[tempY + "_" + tempX];
                var gridObj = grid[tempY][tempX];

                if ((gridObj != '#' && gridObj != '%' )) {
                    
                    player.x = tempX;
                    player.y = tempY;

                    if (objOnPos) {
                        scene.remove(objOnPos);
                        gridObjects[player.y + "_" + player.x] = null;
                    }
                    
                    grid[player.y][player.x] = " ";
                    player.obj.position.z = player.y;
                    player.obj.position.x = player.x;


                }


                //console.log(camera.position);
                //console.log(controls.target);
                //		camera.position.set(x,y,z);
                //			controls.target.set(x,y,z);


            });
        }

        // Load the object
        var jsonLoader = new THREE.JSONLoader();

        jsonLoader.load("Models/monkeyshaded.json", function (geometry, materials) {
            monkeyMaterial = new THREE.MultiMaterial(materials);
            monkeyGeometry = geometry;
            loadedModels++;
            init();
        });

        jsonLoader.load("Models/bomb.json", function (geometry, materials) {
            bombMaterial = new THREE.MultiMaterial(materials);
            bombGeometry = geometry;
            loadedModels++;
            init();
        });
		
		
			var textureLoader = new THREE.TextureLoader();
			
		textureLoader.load("images/powerup_power.png", function(texture){
        	powerUp1Material = new THREE.SpriteMaterial( { map: texture, color: 0xffffff } );
		//	var sprite = new THREE.Sprite( spriteMaterial );
		//	scene.add( sprite );
			loadedModels++;
			init();
		  });
		  
		  
		 	textureLoader.load("images/powerup_bomb.png", function(texture){
        	powerUp2Material = new THREE.SpriteMaterial( { map: texture, color: 0xffffff } );
		//	var sprite = new THREE.Sprite( spriteMaterial );
		//	scene.add( sprite );
			loadedModels++;
			init();
		  });
		

        controls = new THREE.OrbitControls(camera, renderer.domElement);
        /*
          // (width, height, depth)
        var geometry = new THREE.BoxGeometry(5, 5, 5);

        var mesh;
          var loader = new THREE.TextureLoader();
        // URL of texture
        loader.load("images/hest.jpg", function(texture){
          var material = new THREE.MeshLambertMaterial({map: texture});
          mesh = new THREE.Mesh(geometry, material);
          scene.add(mesh);  });
      */

        function render() {
            requestAnimationFrame(render);
            var num = Math.random();
            //console.log(num);
            //  mesh.rotation.x += 0.005;

            //light.rotation.x += 0.01;
            //      mesh.scale.x = 1 + num / 50;

            //     mesh.rotation.y += 0.005;
            renderer.render(scene, camera);
            controls.update();
            //	console.log(controls.target);
        }

    </script>
</body>
</html>